o<tool_touch_off> sub

;Subprogram for manuel tool change with measurement of the tool.
;Version date: 2023-11-05
;Version: 3.1.0
;https://github.com/TooTall18T/tool_length_probe

;This subprogram is based on the original subprogram "tool_touch_off.ngc" that came with Probe Basic.

;The parameters 4000 till 4005 must be in the .var-file which is registered under "PARAMETER_FILE" in the machine .ini-file.


;-1- Transfer parameters
;Adding and changing the variables and transfer parameters leads to the routine not being executed (LinuxCNC/Probe Basic).
#<fast_probe_fr> = #1                 (#4000 set from probe screen fast probe feed rate)
#<slow_probe_fr> = #2                 (#4001 set from probe screen slow probe feedrate)
#<z_max_travel> = #3                  (#4002 max z distance the tool travels before erroring out if not contact is made)
#<xy_max_travel> = #4                 (#4003 max xy distance the tool travels before erroring out if not contact is made)
#<spindle_zero_height> = #5           (#4004 G53 distance from spindle nose triggering point on touch plate up for tools with zero length)
#<retract_distance> = #6              (#4005 distance the tool retracts after making contact during fast feed mode)
#<tool_diameter_probe_mode> = #8      (not in use, activates the tool diameter probe subroutine section)
#<tool_diameter_offset_mode> = #9     (not in use, activates the tool diameter offset position for probe subroutine section)
#<tool_diameter> = #10                (not in use, current tool's diameter used for offseting probe position in x axis)


;-2- Fixed parameters
;-MAIN-
#<debug_mode> = 0		    ;The debug mode for troubleshooting is set here. 0=OFF, 1=log file . File in the machine's config folder.
#<use_tool_table> = 1               ;If "1" the machine uses the tool table for positioning the tool over the 
#<tool_min_dis> = 20                ;Distance, when measuring a known tool again, between the touch plate and the tool.

;-OPTIONS-
;--Generally--
#<brake_after_M600> = 1	      	    ;If ">0" wait for confirmation that the program may continue to work after the measurement. 1=M00, 2=M01
#<go_back_to_start_pos> = 1         ;If "1" the machine returns to the position where the routine was started.
#<spindle_stop_m> = 5               ;M-Code number to stop the spindle default 5 (M5), option 500 (M500).
#<addreps> = 0                      ;Number of extra repetitions for fast probe.

;--Tool diameter--
#<offset_diameter> = 0              ;Tool diameter from when a offset should take place. 0=OFF
#<offset_direction> = 0             ;Direction of the offset. 0=X+ 1=X- 2=Y+ 3=Y-
#<offset_value> = 50                ;How much of the tool diameter should move in percent.

;--Tool edge-finder--
#<finder_number> = 0                ;Tool number of the edge-finder
#<finder_touch_x_coords> = 0        ;x coordinate for the z reference position in G53
#<finder_touch_y_coords> = 0        ;y coordinate for the z reference position in G53
#<finder_diff_z> = 0                ;Differenz between tool touch button and reference surface.

;--Pre change position--
#<tool_change_x> = 0                ;To change the position where to change the tool befor measuring. If not "0" is G53 X-position
#<tool_change_y> = 0                ;To change the position where to change the tool befor measuring. If not "0" is G53 Y-position



;-3- Create debug mode log file
o<10> if [#<debug_mode> GT 0]
  (debug, logfile.txt created in the configuration folder)
  (logopen,logfile.txt)
  (log, Log file for the subroutine "tool_touch_off.ngc" Version 3.1.0 from TooTall18T)
  (log, Fast: #<fast_probe_fr>)
  (log, FAST.var: #4000)
  (log, Slow: #<slow_probe_fr>)
  (log, SLOW.var: #4001)
  (log, Zmax travel: #<z_max_travel>)
  (log, ZMAX TRAVEL.var: #4002)
  (log, XY max travel: #<xy_max_travel>)
  (log, XY MAX TRAVEL.var: #4003)
  (log, spindle_zero_height: #<spindle_zero_height>)
  (log, SPINDLE ZERO HEIGHT.var: #4004)
  (log, Retract: #<retract_distance>)
  (log, RETRACT.var: #4005)
  (log, Min XYZ: #<_ini[AXIS_X]MIN_LIMIT> #<_ini[AXIS_Y]MIN_LIMIT> #<_ini[AXIS_Z]MIN_LIMIT>)
  (log, Max XYZ: #<_ini[AXIS_X]MAX_LIMIT> #<_ini[AXIS_Y]MAX_LIMIT> #<_ini[AXIS_Z]MAX_LIMIT>)
  (log, Pos XYZ: #5420 #5421 #5422)
  (log, Back: #<go_back_to_start_pos>)
  (log, tool touch z coodrs: #5183)
  (log, tool table: #<use_tool_table>)
  (log, tool min dis: #<tool_min_dis>)
  (log, Brake: #<brake_after_M600>)
  (log, Spindel stop: #<spindle_stop_m>)
  (log, offset_diameter: #<offset_diameter>)
  (log, offset_direction: #<offset_direction>)
  (log, offset_value: #<offset_value>)
  (log, Finder No: #<finder_number>)
  (log, Finder X: #<finder_touch_x_coords> )
  (log, Finder Y: #<finder_touch_y_coords> )
  (log, Finder diff: #<finder_diff_z>)
  (log, Change pos X: #<tool_change_x>)
  (log, Change pos Y#<tool_change_y>)
  (log, ============================)
o<10>endif


;-4- Check for manual tool calibration and new parameters
;The value "0" is transferred at all points via subprogram M600.
;The check for "0" distinguishes between automatic and manual measurement.
o<80> if [#<fast_probe_fr> EQ 0 AND #<slow_probe_fr> EQ 0 AND #<z_max_travel> EQ 0 AND #<xy_max_travel> EQ 0 AND #<spindle_zero_height> EQ0 AND #<retract_distance> EQ 0]
  #<auto> = 1
  #<fast_probe_fr> = #4000
  #<slow_probe_fr> = #4001
  #<z_max_travel> = #4002
  #<xy_max_travel> = #4003
  #<spindle_zero_height> = #4004
  o<82> if [#4005 NE 0]
    ;When loading the CNC program, this is checked, but the parameters from the .var file are not loaded.
    ;When #<retract_distance> is 0 that leads to an error: "Start point too close to probe point".
    ;Should #4005(retract_distance) = 0, it is set to 1 to allow the check to run without errors.
    #<retract_distance> = #4005
  o<82> else
    #<retract_distance> = 1
  o<82> endif
  #<para> = -1
o<80> else
  #<auto> = 0
  o<81> if [#<fast_probe_fr> NE #4000 OR #<slow_probe_fr> NE #4001 OR #<z_max_travel> NE #4002 OR #<xy_max_travel> NE #4003 OR #<spindle_zero_height> NE#4004 OR #<retract_distance> NE #4005]
    ;If a value has been changed via the user interface, this is saved in the variable file when [TOUCH OF CURRENT TOOL] is triggered.
    ;If the values are saved, no measurement is carried out, only a message (New parameters saved!) is displayed.
    #4000 = #<fast_probe_fr>
    #4001 = #<slow_probe_fr>
    #4002 = #<z_max_travel>
    #4003 = #<xy_max_travel>
    #4004 = #<spindle_zero_height>
    #4005 = #<retract_distance>
    #<para> = 1
    (msg, New parameters saved!)
    (log, END SAVE)
    (LOGCLOSE)
    o<tool_touch_off> return
  o<81> else
    #<para> = 0
    ;(debug, Same parameter)
  o<81> endif
o<80> endif


;G92.1    (Cancel G92 offset)       ;TODO: Check if needed

;-5- Save the stop position and coordinate system of the cnc program
#<stop_position_x> = #5420          ;current X position in the current coordinate system
#<stop_position_y> = #5421          ;current Y position in the current coordinate system
#<stop_position_z> = #5422          ;current Z position in the current coordinate system
#<offset_z> = 0                     ;Stores the current Z position in the current coordinate system, will be set later


;-6- Save tool number of old and new tool
#<tool_in_spindle> = #<_current_tool>   ;Value from system variable
#<tool_selected> = #<_selected_tool>    ;Value from system variable
(log, Automatic: #<auto>)
(log, Parameters: #<para>)
(log, Old tool: #<tool_in_spindle> / New tool: #<tool_selected>)


;-7- Global parameters of the tool change point
#<tool_touch_x_coords> = #5181      ;Position of the length button in X
#<tool_touch_y_coords> = #5182      ;Position of the length button in Y
#<tool_touch_z_coords> = #5183      ;Position of the length button in Z


;-8- Compare new and old tool numbers
;If the tool in the spindle is the same as the one selected, no change is made. Except for manual measurement.
o<90> if [#<auto> EQ 1]
  o<92> if [#<tool_in_spindle> EQ #<tool_selected>]
    (msg, Same tool)
    o<94> if [ #<brake_after_M600> EQ 1]     
	    M00					;Interrupts the program flow until you press Start again
    o<94> elseif [#<brake_after_M600> EQ 2]
      M01			    ;If option is selected and [M01 BREAK] is selected in the interface, the machine pauses.
    o<94> endif
    (log, END same tool)
    (LOGCLOSE)
    o<tool_touch_off> return
  o<92> endif
o<90> endif


;-9- Change to T0
;A change at the end of the CNC program using "M600 T0" can cause LinuxCNC to switch from G43 to G49 if the program aborts!
;If the program is restarted, it may not switch back to G43. Danger of collision!
;The case only serves to ensure that a measurement is not accidentally started with tool 0.
o<100> if [#<tool_selected> EQ 0]
  G90
  G53 G0 Z0
  M6 T#<tool_selected> 
  G49
  (log, END M6 T0)
  (LOGCLOSE)
  o<tool_touch_off> return
o<100> endif
(log, ============================)


;-10- Start of loop
;If #<addreps> is higher than "0" and fast probe failed, the routine does a loop to refit the tool and probe again.
#<fastprobefailed> = 0
#<addreps> = [#<addreps> + 1]
o<200> do


  ;-11- Positioning over tool length sensor / pre change position / edge-finder position
  ;Turn off spindle befor the machine moves to probe / pre change  / edge-finder position.
  G49
  G90             (set absolute coordinates)
  G53 G0 Z0       (move to z0 home position)
  #<offset_z> = #5422         ;Stores the offset of the current Z coordinate at G53 Z0 without tool offset.
  M#<spindle_stop_m>
  o<106> if [#<auto> EQ 1 AND [#<tool_change_x> NE 0 OR #<tool_change_y> NE 0]]
    ;Pre change position
    G53 G0 X#<tool_change_x> Y#<tool_change_y>
  o<106> elseif [#<finder_number> GT 0 AND #<tool_selected> EQ #<finder_number>]
    ;Edge-finder position
    G53 G0 X#<finder_touch_x_coords> Y#<finder_touch_y_coords>
  o<106> else
    ;Tool touch position
    G53 G0 X#<tool_touch_x_coords> Y#<tool_touch_y_coords>
  o<106> endif
  (log, Offset_Z: #<offset_z>)


  ;-12- Tool change
  M6 T#<tool_selected> 
  #<tool_length_old> = #5403                  ;Old tool length of the tool selected by T
  (log, Old tool length: #<tool_length_old>)


  ;-13- Stops at probe fail
  ;If last probe failed, machine stops to refit the tool. Press [CYCLE START] to repeat, or [STOP] to cancel.
  o<203> if [#<fastprobefailed> EQ 1]
    (debug, Tool Length Offset Probe Failed. Attempts left: #<addreps> Press [CYCLE START] to repeat, or [STOP] to cancel.)
    (log, === Probe failed, Attempts left: #<addreps> ===)
    M00
  o<203> endif


  ;-14- Positioning for measuring
  
  o<160> if [#<finder_number> GT 0 AND #<tool_selected> EQ #<finder_number>] 
    ;Edge-finder position
    G53 G0 X#<finder_touch_x_coords> Y#<finder_touch_y_coords>
  o<160> else                                                   
    o<107> if [#<offset_diameter> GT 0 AND #<offset_diameter> LE #5410]
      ;Tool diameter correction
      #<offset_distance> = [[#5410 * #<offset_value>]/100]
      (log, Offset_dis: #<offset_distance>)
      o<108> if [#<offset_direction> EQ 1]
        ;Offset X-
        G53 G0 X[#<tool_touch_x_coords>-#<offset_distance>] Y#<tool_touch_y_coords>
      o<108> elseif [#<offset_direction> EQ 2]
        ;Offset Y+
        G53 G0 X#<tool_touch_x_coords> Y[#<tool_touch_y_coords>+#<offset_distance>]
      o<108> elseif [#<offset_direction> EQ 3]
        ;Offset Y-
        G53 G0 X#<tool_touch_x_coords> Y[#<tool_touch_y_coords>-#<offset_distance>]
      o<108> else
        ;Offset X+
        G53 G0 X[#<tool_touch_x_coords>+#<offset_distance>] Y#<tool_touch_y_coords>
      o<108> endif
    o<107> else
      ;Tool touch position
      G53 G0 X#<tool_touch_x_coords> Y#<tool_touch_y_coords>
    o<107> endif 
  o<160> endif


  ;-15- Determination of the Z starting position for G38
  o<110> if [#<use_tool_table> EQ 1 AND #<tool_length_old> GT 0]
    ;If the machine uses the tool table and the tool length ist greater than 0 .
    #<probe_start_pos_z> = [#<tool_touch_z_coords> + #<tool_length_old> + #<tool_min_dis>]
    ;(msg, Old tool)
  o<110> else
    ;If the machine dosen't use the tool table or for tools with a unknown length (<=0).
    #<probe_start_pos_z> = [#<tool_touch_z_coords> + #<spindle_zero_height>]
    #<z_max_travel> = #<spindle_zero_height>
    ;(msg, New tool)
  o<110> endif
  o<111> if [#<tool_selected> EQ #<finder_number>]
    #<probe_start_pos_z> = [#<probe_start_pos_z> + #<finder_diff_z>]
  o<111>endif
  (log, Probe start pos: #<probe_start_pos_z>)
  (log, max travel: #<z_max_travel>)


  ;-16- Move to Z start position for length measurement
  G53 G0 Z#<probe_start_pos_z>


  ;-17- Fast probe
  G91
  F #<fast_probe_fr>
  G38.3 Z-[#<z_max_travel>]    (fast tool probe)
  G0 Z[#<retract_distance>]    (retract tool retract distance amount)
  G90
  #<addreps> = [#<addreps> - 1]
  (log, Fast probe: #5063)


  ;-18- Verify fast probe event was succesful
  o<201> if [#5070 NE 1]
    o<202> if [#<addreps> EQ 0]
      G90
      (abort, Tool length offset probe failed!)
    o<202> else
      #<fastprobefailed> = 1
    o<202> endif
  o<201> else
    #<addreps> = 0
  o<201> endif


;-19- End of loop
o<200> while [#<addreps> GT 0]
(log, ============================)


;-20- Slow probe
(Slow Probe Rule, if Slow Probe FR is set to 0, Slow Probe is Bypassed)
o<120> if [#<slow_probe_fr> GT 0]
  (Initiate Slow Z- Probe)
  G91
  F[#<slow_probe_fr>]    (set probe slow feedrate)
  G38.2 Z-[#<retract_distance> * 2]    (slow tool probe)
  #<z_slow_probe> = #5063
  G90
  G0 Z[#<z_slow_probe> + #<retract_distance>]
  (log, Slow probe: #5063)
o<120> endif


;-21- Check for a successful measurement result
o<130> if [#5070 EQ 1]    (verify probe event was succesful)
  #<z_slow_probe> = #5063    (save slow probe result to parameters)
o<130> else
  (MSG, Tool Length Offset Probe Failed)
o<130> endif


;-22- Define new tool length
(define new tool length offset parameters)
o<131> if [#<tool_selected> EQ #<finder_number>]
  #<new_tool_length_offset> = [ABS[[#<tool_touch_z_coords>*[-1]] + #5063 - #<finder_diff_z>]-#<offset_z>]
o<131> else
  #<new_tool_length_offset> = [ABS[[#<tool_touch_z_coords>*[-1]] + #5063]-#<offset_z>]
o<131>endif
(log, New tool length: #<new_tool_length_offset>)


;-23- Drive the tool free
G90    (set absolute coordinates)
G53 G0 Z0 (Send spindle to home zero position)


;-24- Save ne tool length
G10 L1 P #5400 Z [#<new_tool_length_offset>]  (5400 = tool number)


;-25- Activate new tool and calculate offset
T #5400 G43  H #5400    (enable tool length offset)


;-26- Return to hold position and choose pause
;Runs only in automatic mode.
o<140> if [#<auto> EQ 1]
  o<141> if [#<go_back_to_start_pos> EQ 1]
    ;(debug,x:#<stop_position_x> / y:#<stop_position_y> / z:#<stop_position_z>)
    G0 X[#<stop_position_x>] Y[#<stop_position_y>]
    G0 Z[#<stop_position_z>]
  o<141> endif
  
  ;Selects the type of pause after the survey.
  o<142> if [ #<brake_after_M600> EQ 1]
    M00			;Interrupts the program flow until you press Start again
  o<142> elseif [#<brake_after_M600> EQ 2]
    M01			;If option is selected and [M01 BREAK] is selected in the interface, the machine pauses.
  o<142> endif

o<140> endif

(log, END)
(LOGCLOSE)
o<tool_touch_off> endsub

M2 (end program)
